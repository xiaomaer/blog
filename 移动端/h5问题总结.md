# h5 问题总结

[TOC]

## HTML 篇

### 刘海屏适配

- ios 适配

```html
<!-- 设置网页在可视窗口的布局方式 -->
<meta name="viewport" content="width=device-width, viewport-fit=cover" />
```

```css
/* 页面主体内容限制在安全区域内 */
@supports (bottom: constant(safe-area-inset-bottom)) or
  (bottom: env(safe-area-inset-bottom)) {
  .page {
    /* ios < 11.2 */
    padding-left: constant(safe-area-inset-left);
    padding-top: constant(safe-area-inset-top);
    padding-right: constant(safe-area-inset-right);
    padding-bottom: constant(safe-area-inset-bottom);
    /* ios >= 11.2 */
    padding-left: env(safe-area-inset-left);
    padding-top: env(safe-area-inset-top);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
  }
}
```

- android 适配

没有统一的适配方案，`建议客户端暴露方法获取刘海的高度`，如果客户端不支持，则可设置为 28px，此高度可适配大多数安卓刘海屏。

```
.page.android {
  padding-top: 28px;
}

```

### 禁止页面缩放

```
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, minimum-scale=1, maximum-scale=1">

```

### 禁止自动识别电话/邮箱

```
<!-- 忽略自动识别电话 -->
<meta name="format-detection" content="telephone=no">

<!-- 忽略自动识别邮箱 -->
<meta name="format-detection" content="email=no">

<!-- 忽略自动识别电话和邮箱 -->
<meta name="format-detection" content="telephone=no, email=no">

```

### 禁止页面缓存

```
<meta http-equiv="Cache-Control" content="no-cache">

```

### 禁止字母大写

```
<input autocapitalize="off" autocorrect="off">

```

### 弹出数字键盘

```
<!-- 纯数字带#和* -->
<input type="tel">

<!-- 纯数字 -->
<input type="number" pattern="\d*">
```

### 调用系统功能（电话/短信/邮件/相册/文件）

```
<!-- 拨打电话 -->
<a href="tel:10086">拨打电话给10086</a>

<!-- 发送短信 -->
<a href="sms:10086">发送短信给10086</a>

<!-- 发送邮件 -->
<a href="mailto:test@test.com">发送邮件给test</a>

<!-- 选择照片或拍摄照片 -->
<input type="file" accept="image/*">

<!-- 选择视频或拍摄视频 -->
<input type="file" accept="video/*">

<!-- 多选文件 -->
<input type="file" multiple>

```

### 唤起原生应用 - 通过自定义 scheme（约定的一种 URL 格式）

```
<!-- 打开微信 -->
<a href="weixin://">打开微信</a>

<!-- 打开支付宝 -->
<a href="alipays://">打开支付宝</a>

<!-- 打开支付宝的扫一扫 -->
<a href="alipays://platformapi/startapp?saId=10000007">打开支付宝的扫一扫</a>

<!-- 打开支付宝的蚂蚁森林 -->
<a href="alipays://platformapi/startapp?appId=60000002">打开支付宝的蚂蚁森林</a>

```

### Safari 特有配置

```
<!-- 设置Safari全屏，在iOS7+无效 -->
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- 改变Safari状态栏样式，可选default/black/black-translucent，需在上述全屏模式下才有效 -->
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<!-- 添加页面启动占位图 -->
<link rel="apple-touch-startup-image" href="pig.jpg" media="(device-width: 375px)">

<!-- 保存网站到桌面时添加图标 -->
<link rel="apple-touch-icon" sizes="76x76" href="pig.jpg">

<!-- 保存网站到桌面时添加图标且清除默认光泽 -->
<link rel="apple-touch-icon-precomposed" href="pig.jpg">

```

### 其他浏览器特有配置 - qq/uc/360 浏览器

```
<!-- 强制QQ浏览器竖屏 -->
<meta name="x5-orientation" content="portrait">

<!-- 强制QQ浏览器全屏 -->
<meta name="x5-fullscreen" content="true">

<!-- 开启QQ浏览器应用模式 -->
<meta name="x5-page-mode" content="app">

<!-- 强制UC浏览器竖屏 -->
<meta name="screen-orientation" content="portrait">

<!-- 强制UC浏览器全屏 -->
<meta name="full-screen" content="yes">

<!-- 开启UC浏览器应用模式 -->
<meta name="browsermode" content="application">

<!-- 开启360浏览器极速模式 -->
<meta name="renderer" content="webkit">

```

## CSS 篇

### 自适应布局

- rem
- vh/vm
- 百分比

### 1px 问题

```
 .elem{
    position: relative;
    &::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: #f0f0f0;
      transform: scaleY(0.5);
    }
  }
```

### 超过一行打点

```
@mixin overflow-ellipsis {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

```

### 超过多行打点

```
@mixin multiple-overflow-ellipsis {
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3; // 设置多行
    -webkit-box-orient: vertical;
}

```

### 开启 GPU 渲染

```
.elem {
    transform: translate3d(0, 0, 0);
    /* transform: translateZ(0); */
}
```

### 使用滚动回弹

解决 ios 上滚动卡顿的问题

```
.elem{
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}
```

### 禁止滚动传播

当页面包含多个滚动区域时，滚完一个区域后若还存在滚动动量则会将这些剩余动量传播到下一个滚动区域，造成该区域也滚动起来。这种行为称为滚动传播。

```
.elem {
    overscroll-behavior: contain;
}

```

### 禁止长按操作

```
* {
    /* pointer-events: none; */ /* 微信浏览器还需附加该属性才有效 */
    user-select: none; /* 禁止长按选择文字 */
    -webkit-touch-callout: none;
}


```

### 禁止文本高亮显示

```
* {
    -webkit-tap-highlight-color: transparent;
}

```

### 禁止动画闪屏

```
.elem {
    perspective: 1000;
    backface-visibility: hidden;
    transform-style: preserve-3d; // 创建3D环境
}

```

### 美化表单外观

```
button,
input,
select,
textarea {
    appearance: none;
    /* 自定义样式 */
}
```

### 自定义滚动条 - `::-webkit-scrollbar-*`

- ::-webkit-scrollbar：滚动条整体部分
- ::-webkit-scrollbar-track：滚动条轨道部分
- ::-webkit-scrollbar-thumb：滚动条滑块部分

```
::-webkit-scrollbar {
    display:none
}
::-webkit-scrollbar-track {
    background-color: transparent;
}
::-webkit-scrollbar-thumb {
    border-radius: 3px;
    background-image: linear-gradient(135deg, #09f, #3c9);
}

```

### 自定义输入占位 - `::-webkit-input-placeholder`

```
input::-webkit-input-placeholder {
    color: #13c2c2;
}

```

### 对齐输入占位

```
input {
    line-height: normal;
}

```

### 对齐下拉选项

```
select option {
    direction: rtl; //下拉框选项默认向左对齐，修改为向右对齐
}

```

### 10px 字体

- 问题描述：默认情况下，浏览器是不支持 12px 以下字体的，如果设置 font-size 小于 12px，会显示为 12px 字体。
- 解决方案：先放大，然后再缩放，代码如下：

```
 .tag-text {
    font-size: 12px; // 放大
    transform: scale(0.83); // 缩小
  }
```

### 不垂直居中问题

- 问题描述：在有些 android 手机，指定高度或字体时，设置了 align-items:center 时，仍然不垂直居中。
- 解决方案：外面加一层元素包裹，设置为实际的高度，里面元素扩大一倍，然后再缩放，代码如下：

```
.button {
      width: 24px;
      height: 24px;
      overflow: hidden;
}
.button .today {
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      width: 48px; // 重要
      height: 48px; // 重要
      color: #13c2c2;
      font-weight: bold;
      font-size: 28px;
      font-family: Montserrat-Medium, Montserrat;
      background: rgba(19, 194, 194, 0.1);
      background: themeColorAlpha('S6', 0.1);
      border: 2px solid rgba(19, 194, 194, 0.5); // 重要
      border-radius: 50%;
      transform: scale(0.5); // 重要
      transform-origin: left top; // 重要
    }

```

### flex 布局最后子元素 margin-right 失效

- 参考：[flex 布局最后子元素 margin-right 失效](../CSS/flex布局最后子元素margin-right失效.md)

### 滚动元素，在顶部下拉时，背景色断层问题

- 参考：[如何设置 div 背景色一半为蓝色一半为白色](../CSS/如何设置div背景色一半为蓝色一半为白色.md)

## JavaScript 篇

### 左右滑动时，禁止上下滚动

- 问题描述：页面出现滚动条，左右滑动切换卡片时，会出现上下滑动，导致页面乱跑
- 解决方案：阻止默认行为（touchmove 事件的默认行为是 scroll），即记录滑动方向，如果开始滑动方向为横向，阻止默认行为，代码如下：

```
  <div
        ref={contenRef}
        style={contentStyle}
        onTouchStart={handleTouchStart}
        onTouchEnd={handleTouchEnd}>
      内容区域
      </div>

const handleTouchMove = useCallback((e: TouchEvent) => {
    if (!dragRef.current) {
      return;
    }
    if (e.touches.length > 1) {
      return;
    }
    const touch = e.touches[0];
    const diffY = touch.pageY - pageY.current;
    let diffX = touch.pageX - pageX.current;
    if (!directionRef.current) {
      directionRef.current = Math.abs(diffX) > Math.abs(diffY) ? 'horizontal' : 'vertical';
    }
    if (directionRef.current === 'horizontal') {
      if (e.cancelable) {
        e.preventDefault();
      }
      // 阻止默认行为
      e.preventDefault();
    }
  }, []);

  const handleTouchStart = useCallback(
    (e: React.TouchEvent<HTMLDivElement>) => {
      contenRef.current!.addEventListener('touchmove', handleTouchMove, { passive: false });
      const touch = e.touches[0];
      pageX.current = touch.pageX;
      pageY.current = touch.pageY;
      directionRef.current = '';
      dragRef.current = true;
    },
    [handleTouchMove],
  );

  const handleTouchEnd = useCallback(
    (e: React.TouchEvent) => {
      dragRef.current = false;
      directionRef.current = '';
      contenRef.current!.removeEventListener('touchmove', handleTouchMove, false);
    },
    [handleTouchMove],
  );
```

### 禁止滚动穿透

- 问题描述：页面内容可滚动且有弹窗时，当在弹窗上滚动时，会导致页面内容也跟着滚动
- 方案 1：当打开弹窗时，获取 scrollTop，并给 body 设置`position:fixed;`和动态 top 为`-${scrollTop}px`；当关闭弹窗时，移除设置的样式

```
body.static {
    position: fixed;
    left: 0;
    width: 100%;
}

const body = document.body;
const openBtn = document.getElementById("open-btn");
const closeBtn = document.getElementById("close-btn");
openBtn.addEventListener("click", e => {
    e.stopPropagation();
    const scrollTop = document.scrollingElement.scrollTop;
    body.classList.add("static");
    body.style.top = `-${scrollTop}px`;
});
closeBtn.addEventListener("click", e => {
    e.stopPropagation();
    body.classList.remove("static");
    body.style.top = "";
});


```

- 方案 2:阻止 touchmove 事件默认行为【待验证】

- 结果：除了弹窗内容能点击或滚动，其他内容都不能点击或滚动

### 禁止点击穿透

- 问题描述：移动端点击后，为了确认是否是双击事件，会有 300ms 延迟，该点击延迟被称为点击穿透。
- 解决方案：使用 touch 事件、使用 fastclick npm 包

### 日期解析

- 问题描述：在苹果系统上解析 YYYY-MM-DD HH:mm:ss 这种日期格式会报错 Invalid Date，但在安卓系统上解析这种日期格式完全无问题。
- 解决方案：Android 和 iOS 通用日期格式为：YYYY/MM/DD HH:mm:ss

```
const date = "2019-03-31 21:30:00";
new Date(date.replace(/\-/g, "/"));
```

### 简化回到顶部

使用 scrollIntoView API。

```
const toTop = document.getElementById("toTop");
toTop.addEventListener("click", () => document.body.scrollIntoView({ behavior: "smooth" }));

```

### 简化上拉加载更多

使用 IntersectionObserver 监听目标元素与祖先元素的关系，即监听目标元素是否进入或者离开了指定父元素的内部

```
let list = document.querySelectorAll("ul li");

let observer = new IntersectionObserver(entries => {
  entries.forEach(item => {
    if (item.isIntersecting) {
      item.target.classList.add("show"); // 增加show类名
      observer.unobserve(item.target); // 移除监听
    }
  });
});

list.forEach(item => observer.observe(item));
```

### 修复输入监听

在苹果系统上的输入框输入文本，keyup/keydown/keypress 事件可能会无效。当输入框监听 keyup 事件时，逐个输入英文和数字会有效，但逐个输入中文不会有效，需按回车键才会有效。

此时`可用 input 事件`代替输入框的 keyup/keydown/keypress 事件。

### 修复输入框失焦后页面未回弹

问题描述：当页面同时出现以下三个条件时，键盘占位会把页面高度压缩一部分。 当输入完成键盘占位消失后，页面高度有可能回不到原来高度，产生坍塌导致 Webview 底色露脸。包括：

- 页面高度过小
- 输入框在页面底部或视窗中下方
- 输入框聚焦输入文本

解决方案：获取焦点时，获取 scrollTop，失去焦点时，根据获取的 scrollTop，回复 scrollTop。

```
const input = document.getElementById("input");
let scrollTop = 0;
input.addEventListener("focus", () => {
    scrollTop = document.scrollingElement.scrollTop;
});
input.addEventListener("blur", () => {
    document.scrollingElement.scrollTo(0, this.scrollTop);
});

```
